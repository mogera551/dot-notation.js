const e="*",t="dot-notation",r=Symbol.for(t+".direct_get"),s=Symbol.for(t+".direct_set");class a{name;pathNames=[];parentPathNames=[];parentPath;regexp;level=0;constructor(t){this.name=t,this.pathNames=t.split("."),this.parentPathNames=this.pathNames.slice(0,-1),this.parentPath=this.parentPathNames.join("."),this.lastPathName=this.pathNames.at(-1),this.regexp=new RegExp("^"+t.replaceAll(".","\\.").replaceAll("*","([0-9a-zA-Z_]*)")+"$"),this.level=this.pathNames.filter((t=>t===e)).length}findNearestWildcard(){return a.findNearestWildcard(this)}static findNearestWildcard(t){return t.lastPathName===e?t:""!==t.parentPath?this.findNearestWildcard(a.create(t.parentPath)):void 0}static create(e){const t=this.propertyNameByName.get(e);if(t)return t;const r=new a(e);return this.propertyNameByName.set(e,r),r}static propertyNameByName=new Map}class n{#e=[];#t;#r;#s;constructor(e){if(null==e)throw new Error("definedProperties is null");this.#t=new Set(e),this.#r=e.map((e=>a.create(e))),this.#s=new Map}get lastIndexes(){return this.#e[this.#e.length-1]}get stackIndexes(){return this.#e}get setOfDefinedProperties(){return this.#t}get definedPropertyNames(){return this.#r}get matchByName(){return this.#s}#a(t,r,s){let n;if(Reflect.has(t,r.name,s))n=Reflect.get(t,r.name,s);else{const i=this.#a(t,a.create(r.parentPath),s),h=r.lastPathName===e?this.lastIndexes[r.level-1]:r.lastPathName;n=Reflect.get(i,h)}return n}#n(t,r,s,n){if(Reflect.has(t,r.name,n))Reflect.set(t,r.name,s,n);else{const i=this.#a(t,a.create(r.parentPath),n),h=r.lastPathName===e?this.lastIndexes[r.level-1]:r.lastPathName;Reflect.set(i,h,s)}return!0}#i(e,t){this.#e.push(e);try{return Reflect.apply(t,this,[])}finally{this.#e.pop()}}#h=(e,t)=>({propName:r,indexes:s})=>this.#i(s,(()=>this.#a(e,r,t)));#o=(e,t)=>({propName:r,indexes:s},a)=>this.#i(s,(()=>this.#n(e,r,a,t)));#p(e,t,r,s){const n=this.#h(e,s),i=t.findNearestWildcard();if(!i)throw new Error(`not found wildcard path of '${t.name}'`);const h=a.create(i.parentPath),o=[];for(let e in n({propName:h,indexes:r}))o.push(n({propName:t,indexes:r.concat(Number(e))}));return o}#c(e,t,r,s,n){const i=this.#h(e,n),h=this.#o(e,n),o=t.findNearestWildcard();if(!o)throw new Error(`not found wildcard path of '${t.name}'`);const p=a.create(o.parentPath),c=i({propName:p,indexes:r});if(o.name===t.name)h({propName:p,indexes:r},s);else{if(s.length!==c.length)throw new Error(`not match value count '${t.name}'`);for(let e in c)h({propName:t,indexes:r.concat(Number(e))},s[e])}return!0}get(e,t,n){const i=this.#h(e,n);let h;if(t===r)return(t,r)=>{if(this.#t.has(t))return this.#i(r,(()=>this.#a(e,a.create(t),n)));throw new Error(`undefined property ${t}`)};if(t===s)return(t,r,s)=>{if(this.#t.has(t))return this.#i(r,(()=>this.#n(e,a.create(t),s,n)));throw new Error(`undefined property ${t}`)};if(h=/^\$([0-9]+)$/.exec(t))return this.lastIndexes?.[Number(h[1])-1]??void 0;if("@"===t.at(0)){const r=t.slice(1);if(!this.#t.has(r))throw new Error(`undefined property ${r}`);const s=a.create(r);if((this.lastIndexes?.length??0)+1<s.level)throw new Error("array level not match");const i=this.lastIndexes?.slice(0,s.level-1)??[];return this.#p(e,s,i,n)}if(this.#t.has(t))return this.#a(e,a.create(t),n);if(this.#s.has(t))return i(this.#s.get(t));for(const e of this.#r){const r=e.regexp.exec(t);if(!r)continue;const s=r.slice(1);return this.#s.set(t,{propName:e,indexes:s}),i({propName:e,indexes:s})}throw new Error(`undefined property ${t}`)}set(e,t,r,s){const n=this.#o(e,s);if("@"===t.at(0)){const n=t.slice(1);if(!this.#t.has(n))throw new Error(`undefined property ${n}`);const i=a.create(n);if((this.lastIndexes?.length??0)+1<i.level)throw new Error("array level not match");const h=this.lastIndexes?.slice(0,i.level-1)??[];return this.#c(e,i,h,r,s)}if(this.#t.has(t))return this.#n(e,a.create(t),r,s);if(this.#s.has(t))return n(this.#s.get(t),r);for(const e of this.#r){const s=e.regexp.exec(t);if(!s)continue;const a=s.slice(1);return this.#s.set(t,{propName:e,indexes:a}),n({propName:e,indexes:a},r)}throw new Error(`undefined property ${t}`)}}export{n as Handler,r as SYM_DIRECT_GET,s as SYM_DIRECT_SET};
